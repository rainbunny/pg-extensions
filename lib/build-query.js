"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.buildQuery = void 0;

const buildMainQuery = ({
  table,
  whereClause,
  fields,
  queryText
}) => {
  const fieldsClause = fields ? fields.map(field => `${field} as "${field}"`).join(',') : '';
  const whereQuery = whereClause ? ` WHERE ${whereClause}` : '';

  if (!fieldsClause && !whereClause && !table) {
    return queryText;
  }

  const tableFromQueryText = `(${queryText}) T`;
  return `SELECT ${fieldsClause || '*'} FROM ${table || tableFromQueryText}${whereQuery}`;
};

const buildSortBy = ({
  sortBy
}) => sortBy && sortBy.length > 0 ? ` ORDER BY ${sortBy.map(m => m.replace('|', ' ')).join(', ')}` : '';

const buildQueryWithoutParams = queryBuilder => {
  const {
    query,
    paramsArr
  } = queryBuilder;
  const {
    pageIndex,
    rowsPerPage
  } = query;
  let {
    limit,
    offset
  } = query;
  let {
    currentParamInx
  } = queryBuilder;
  let finalQueryText;
  const areMultipleQueries = query.queryText && query.queryText.split(';').filter(q => q).length > 1;

  if (areMultipleQueries) {
    finalQueryText = query.queryText;
  } else {
    finalQueryText = buildMainQuery(query) + buildSortBy(query);

    if (typeof pageIndex === 'number' && typeof rowsPerPage === 'number') {
      limit = rowsPerPage;
      offset = rowsPerPage * pageIndex;
    }

    if (typeof limit === 'number') {
      finalQueryText += ` LIMIT $${currentParamInx}`;
      paramsArr.push(limit);
      currentParamInx += 1;
    }

    if (typeof offset === 'number') {
      finalQueryText += ` OFFSET $${currentParamInx}`;
      paramsArr.push(offset);
      currentParamInx += 1;
    }
  }

  return {
    query,
    finalQueryText,
    currentParamInx,
    paramsArr
  };
};

const addParams = queryBuilder => {
  const {
    query,
    paramsArr
  } = queryBuilder;
  let {
    finalQueryText,
    currentParamInx
  } = queryBuilder;
  const {
    params
  } = query;

  if (params) {
    Object.keys(params).forEach(paramName => {
      const splitQueryArr = finalQueryText.split(`:${paramName}`);

      if (splitQueryArr.length > 1) {
        let newQuery = splitQueryArr[0];
        splitQueryArr.forEach((part, index) => {
          if (index > 0) {
            newQuery += `$${currentParamInx}${part}`;
            paramsArr.push(params[paramName]);
            currentParamInx += 1;
          }
        });
        finalQueryText = newQuery;
      }
    });
  }

  return {
    query,
    finalQueryText,
    currentParamInx,
    paramsArr
  };
};
/** build postgres sql query & params */


const buildQuery = query => {
  const {
    finalQueryText,
    paramsArr
  } = addParams(buildQueryWithoutParams({
    query,
    finalQueryText: '',
    currentParamInx: 1,
    paramsArr: []
  }));
  return {
    queryText: finalQueryText,
    params: paramsArr
  };
};

exports.buildQuery = buildQuery;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9idWlsZC1xdWVyeS50cyJdLCJuYW1lcyI6WyJidWlsZE1haW5RdWVyeSIsInRhYmxlIiwid2hlcmVDbGF1c2UiLCJmaWVsZHMiLCJxdWVyeVRleHQiLCJmaWVsZHNDbGF1c2UiLCJtYXAiLCJmaWVsZCIsImpvaW4iLCJ3aGVyZVF1ZXJ5IiwidGFibGVGcm9tUXVlcnlUZXh0IiwiYnVpbGRTb3J0QnkiLCJzb3J0QnkiLCJsZW5ndGgiLCJtIiwicmVwbGFjZSIsImJ1aWxkUXVlcnlXaXRob3V0UGFyYW1zIiwicXVlcnlCdWlsZGVyIiwicXVlcnkiLCJwYXJhbXNBcnIiLCJwYWdlSW5kZXgiLCJyb3dzUGVyUGFnZSIsImxpbWl0Iiwib2Zmc2V0IiwiY3VycmVudFBhcmFtSW54IiwiZmluYWxRdWVyeVRleHQiLCJhcmVNdWx0aXBsZVF1ZXJpZXMiLCJzcGxpdCIsImZpbHRlciIsInEiLCJwdXNoIiwiYWRkUGFyYW1zIiwicGFyYW1zIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJwYXJhbU5hbWUiLCJzcGxpdFF1ZXJ5QXJyIiwibmV3UXVlcnkiLCJwYXJ0IiwiaW5kZXgiLCJidWlsZFF1ZXJ5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBVUEsTUFBTUEsY0FBYyxHQUFHLENBQUM7QUFBQ0MsRUFBQUEsS0FBRDtBQUFRQyxFQUFBQSxXQUFSO0FBQXFCQyxFQUFBQSxNQUFyQjtBQUE2QkMsRUFBQUE7QUFBN0IsQ0FBRCxLQUE4RDtBQUNuRixRQUFNQyxZQUFZLEdBQUdGLE1BQU0sR0FBR0EsTUFBTSxDQUFDRyxHQUFQLENBQVlDLEtBQUQsSUFBWSxHQUFFQSxLQUFNLFFBQU9BLEtBQU0sR0FBNUMsRUFBZ0RDLElBQWhELENBQXFELEdBQXJELENBQUgsR0FBK0QsRUFBMUY7QUFDQSxRQUFNQyxVQUFVLEdBQUdQLFdBQVcsR0FBSSxVQUFTQSxXQUFZLEVBQXpCLEdBQTZCLEVBQTNEOztBQUNBLE1BQUksQ0FBQ0csWUFBRCxJQUFpQixDQUFDSCxXQUFsQixJQUFpQyxDQUFDRCxLQUF0QyxFQUE2QztBQUMzQyxXQUFPRyxTQUFQO0FBQ0Q7O0FBQ0QsUUFBTU0sa0JBQWtCLEdBQUksSUFBR04sU0FBVSxLQUF6QztBQUNBLFNBQVEsVUFBU0MsWUFBWSxJQUFJLEdBQUksU0FBUUosS0FBSyxJQUFJUyxrQkFBbUIsR0FBRUQsVUFBVyxFQUF0RjtBQUNELENBUkQ7O0FBVUEsTUFBTUUsV0FBVyxHQUFHLENBQUM7QUFBQ0MsRUFBQUE7QUFBRCxDQUFELEtBQ2xCQSxNQUFNLElBQUlBLE1BQU0sQ0FBQ0MsTUFBUCxHQUFnQixDQUExQixHQUErQixhQUFZRCxNQUFNLENBQUNOLEdBQVAsQ0FBWVEsQ0FBRCxJQUFPQSxDQUFDLENBQUNDLE9BQUYsQ0FBVSxHQUFWLEVBQWUsR0FBZixDQUFsQixFQUF1Q1AsSUFBdkMsQ0FBNEMsSUFBNUMsQ0FBa0QsRUFBN0YsR0FBaUcsRUFEbkc7O0FBR0EsTUFBTVEsdUJBQXVCLEdBQUlDLFlBQUQsSUFBOEM7QUFDNUUsUUFBTTtBQUFDQyxJQUFBQSxLQUFEO0FBQVFDLElBQUFBO0FBQVIsTUFBcUJGLFlBQTNCO0FBQ0EsUUFBTTtBQUFDRyxJQUFBQSxTQUFEO0FBQVlDLElBQUFBO0FBQVosTUFBMkJILEtBQWpDO0FBQ0EsTUFBSTtBQUFDSSxJQUFBQSxLQUFEO0FBQVFDLElBQUFBO0FBQVIsTUFBa0JMLEtBQXRCO0FBQ0EsTUFBSTtBQUFDTSxJQUFBQTtBQUFELE1BQW9CUCxZQUF4QjtBQUNBLE1BQUlRLGNBQUo7QUFDQSxRQUFNQyxrQkFBa0IsR0FBR1IsS0FBSyxDQUFDZCxTQUFOLElBQW1CYyxLQUFLLENBQUNkLFNBQU4sQ0FBZ0J1QixLQUFoQixDQUFzQixHQUF0QixFQUEyQkMsTUFBM0IsQ0FBbUNDLENBQUQsSUFBT0EsQ0FBekMsRUFBNENoQixNQUE1QyxHQUFxRCxDQUFuRzs7QUFFQSxNQUFJYSxrQkFBSixFQUF3QjtBQUN0QkQsSUFBQUEsY0FBYyxHQUFHUCxLQUFLLENBQUNkLFNBQXZCO0FBQ0QsR0FGRCxNQUVPO0FBQ0xxQixJQUFBQSxjQUFjLEdBQUd6QixjQUFjLENBQUNrQixLQUFELENBQWQsR0FBd0JQLFdBQVcsQ0FBQ08sS0FBRCxDQUFwRDs7QUFDQSxRQUFJLE9BQU9FLFNBQVAsS0FBcUIsUUFBckIsSUFBaUMsT0FBT0MsV0FBUCxLQUF1QixRQUE1RCxFQUFzRTtBQUNwRUMsTUFBQUEsS0FBSyxHQUFHRCxXQUFSO0FBQ0FFLE1BQUFBLE1BQU0sR0FBR0YsV0FBVyxHQUFHRCxTQUF2QjtBQUNEOztBQUNELFFBQUksT0FBT0UsS0FBUCxLQUFpQixRQUFyQixFQUErQjtBQUM3QkcsTUFBQUEsY0FBYyxJQUFLLFdBQVVELGVBQWdCLEVBQTdDO0FBQ0FMLE1BQUFBLFNBQVMsQ0FBQ1csSUFBVixDQUFlUixLQUFmO0FBQ0FFLE1BQUFBLGVBQWUsSUFBSSxDQUFuQjtBQUNEOztBQUNELFFBQUksT0FBT0QsTUFBUCxLQUFrQixRQUF0QixFQUFnQztBQUM5QkUsTUFBQUEsY0FBYyxJQUFLLFlBQVdELGVBQWdCLEVBQTlDO0FBQ0FMLE1BQUFBLFNBQVMsQ0FBQ1csSUFBVixDQUFlUCxNQUFmO0FBQ0FDLE1BQUFBLGVBQWUsSUFBSSxDQUFuQjtBQUNEO0FBQ0Y7O0FBRUQsU0FBTztBQUNMTixJQUFBQSxLQURLO0FBRUxPLElBQUFBLGNBRks7QUFHTEQsSUFBQUEsZUFISztBQUlMTCxJQUFBQTtBQUpLLEdBQVA7QUFNRCxDQWxDRDs7QUFvQ0EsTUFBTVksU0FBUyxHQUFJZCxZQUFELElBQThDO0FBQzlELFFBQU07QUFBQ0MsSUFBQUEsS0FBRDtBQUFRQyxJQUFBQTtBQUFSLE1BQXFCRixZQUEzQjtBQUNBLE1BQUk7QUFBQ1EsSUFBQUEsY0FBRDtBQUFpQkQsSUFBQUE7QUFBakIsTUFBb0NQLFlBQXhDO0FBQ0EsUUFBTTtBQUFDZSxJQUFBQTtBQUFELE1BQVdkLEtBQWpCOztBQUNBLE1BQUljLE1BQUosRUFBWTtBQUNWQyxJQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWUYsTUFBWixFQUFvQkcsT0FBcEIsQ0FBNkJDLFNBQUQsSUFBZTtBQUN6QyxZQUFNQyxhQUFhLEdBQUdaLGNBQWMsQ0FBQ0UsS0FBZixDQUFzQixJQUFHUyxTQUFVLEVBQW5DLENBQXRCOztBQUNBLFVBQUlDLGFBQWEsQ0FBQ3hCLE1BQWQsR0FBdUIsQ0FBM0IsRUFBOEI7QUFDNUIsWUFBSXlCLFFBQVEsR0FBR0QsYUFBYSxDQUFDLENBQUQsQ0FBNUI7QUFDQUEsUUFBQUEsYUFBYSxDQUFDRixPQUFkLENBQXNCLENBQUNJLElBQUQsRUFBT0MsS0FBUCxLQUFpQjtBQUNyQyxjQUFJQSxLQUFLLEdBQUcsQ0FBWixFQUFlO0FBQ2JGLFlBQUFBLFFBQVEsSUFBSyxJQUFHZCxlQUFnQixHQUFFZSxJQUFLLEVBQXZDO0FBQ0FwQixZQUFBQSxTQUFTLENBQUNXLElBQVYsQ0FBZUUsTUFBTSxDQUFDSSxTQUFELENBQXJCO0FBQ0FaLFlBQUFBLGVBQWUsSUFBSSxDQUFuQjtBQUNEO0FBQ0YsU0FORDtBQU9BQyxRQUFBQSxjQUFjLEdBQUdhLFFBQWpCO0FBQ0Q7QUFDRixLQWJEO0FBY0Q7O0FBQ0QsU0FBTztBQUNMcEIsSUFBQUEsS0FESztBQUVMTyxJQUFBQSxjQUZLO0FBR0xELElBQUFBLGVBSEs7QUFJTEwsSUFBQUE7QUFKSyxHQUFQO0FBTUQsQ0ExQkQ7QUE0QkE7OztBQUNPLE1BQU1zQixVQUFVLEdBQUl2QixLQUFELElBQTZEO0FBQ3JGLFFBQU07QUFBQ08sSUFBQUEsY0FBRDtBQUFpQk4sSUFBQUE7QUFBakIsTUFBOEJZLFNBQVMsQ0FDM0NmLHVCQUF1QixDQUFDO0FBQUNFLElBQUFBLEtBQUQ7QUFBUU8sSUFBQUEsY0FBYyxFQUFFLEVBQXhCO0FBQTRCRCxJQUFBQSxlQUFlLEVBQUUsQ0FBN0M7QUFBZ0RMLElBQUFBLFNBQVMsRUFBRTtBQUEzRCxHQUFELENBRG9CLENBQTdDO0FBSUEsU0FBTztBQUNMZixJQUFBQSxTQUFTLEVBQUVxQixjQUROO0FBRUxPLElBQUFBLE1BQU0sRUFBRWI7QUFGSCxHQUFQO0FBSUQsQ0FUTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHtEYlF1ZXJ5fSBmcm9tICcuL2ludGVyZmFjZXMnO1xuXG5pbnRlcmZhY2UgUXVlcnlCdWlsZGVyIHtcbiAgcXVlcnk6IERiUXVlcnk7XG4gIGZpbmFsUXVlcnlUZXh0OiBzdHJpbmc7XG4gIGN1cnJlbnRQYXJhbUlueDogbnVtYmVyO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICBwYXJhbXNBcnI6IGFueVtdO1xufVxuXG5jb25zdCBidWlsZE1haW5RdWVyeSA9ICh7dGFibGUsIHdoZXJlQ2xhdXNlLCBmaWVsZHMsIHF1ZXJ5VGV4dH06IERiUXVlcnkpOiBzdHJpbmcgPT4ge1xuICBjb25zdCBmaWVsZHNDbGF1c2UgPSBmaWVsZHMgPyBmaWVsZHMubWFwKChmaWVsZCkgPT4gYCR7ZmllbGR9IGFzIFwiJHtmaWVsZH1cImApLmpvaW4oJywnKSA6ICcnO1xuICBjb25zdCB3aGVyZVF1ZXJ5ID0gd2hlcmVDbGF1c2UgPyBgIFdIRVJFICR7d2hlcmVDbGF1c2V9YCA6ICcnO1xuICBpZiAoIWZpZWxkc0NsYXVzZSAmJiAhd2hlcmVDbGF1c2UgJiYgIXRhYmxlKSB7XG4gICAgcmV0dXJuIHF1ZXJ5VGV4dDtcbiAgfVxuICBjb25zdCB0YWJsZUZyb21RdWVyeVRleHQgPSBgKCR7cXVlcnlUZXh0fSkgVGA7XG4gIHJldHVybiBgU0VMRUNUICR7ZmllbGRzQ2xhdXNlIHx8ICcqJ30gRlJPTSAke3RhYmxlIHx8IHRhYmxlRnJvbVF1ZXJ5VGV4dH0ke3doZXJlUXVlcnl9YDtcbn07XG5cbmNvbnN0IGJ1aWxkU29ydEJ5ID0gKHtzb3J0Qnl9OiBEYlF1ZXJ5KTogc3RyaW5nID0+XG4gIHNvcnRCeSAmJiBzb3J0QnkubGVuZ3RoID4gMCA/IGAgT1JERVIgQlkgJHtzb3J0QnkubWFwKChtKSA9PiBtLnJlcGxhY2UoJ3wnLCAnICcpKS5qb2luKCcsICcpfWAgOiAnJztcblxuY29uc3QgYnVpbGRRdWVyeVdpdGhvdXRQYXJhbXMgPSAocXVlcnlCdWlsZGVyOiBRdWVyeUJ1aWxkZXIpOiBRdWVyeUJ1aWxkZXIgPT4ge1xuICBjb25zdCB7cXVlcnksIHBhcmFtc0Fycn0gPSBxdWVyeUJ1aWxkZXI7XG4gIGNvbnN0IHtwYWdlSW5kZXgsIHJvd3NQZXJQYWdlfSA9IHF1ZXJ5O1xuICBsZXQge2xpbWl0LCBvZmZzZXR9ID0gcXVlcnk7XG4gIGxldCB7Y3VycmVudFBhcmFtSW54fSA9IHF1ZXJ5QnVpbGRlcjtcbiAgbGV0IGZpbmFsUXVlcnlUZXh0OiBzdHJpbmc7XG4gIGNvbnN0IGFyZU11bHRpcGxlUXVlcmllcyA9IHF1ZXJ5LnF1ZXJ5VGV4dCAmJiBxdWVyeS5xdWVyeVRleHQuc3BsaXQoJzsnKS5maWx0ZXIoKHEpID0+IHEpLmxlbmd0aCA+IDE7XG5cbiAgaWYgKGFyZU11bHRpcGxlUXVlcmllcykge1xuICAgIGZpbmFsUXVlcnlUZXh0ID0gcXVlcnkucXVlcnlUZXh0O1xuICB9IGVsc2Uge1xuICAgIGZpbmFsUXVlcnlUZXh0ID0gYnVpbGRNYWluUXVlcnkocXVlcnkpICsgYnVpbGRTb3J0QnkocXVlcnkpO1xuICAgIGlmICh0eXBlb2YgcGFnZUluZGV4ID09PSAnbnVtYmVyJyAmJiB0eXBlb2Ygcm93c1BlclBhZ2UgPT09ICdudW1iZXInKSB7XG4gICAgICBsaW1pdCA9IHJvd3NQZXJQYWdlO1xuICAgICAgb2Zmc2V0ID0gcm93c1BlclBhZ2UgKiBwYWdlSW5kZXg7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgbGltaXQgPT09ICdudW1iZXInKSB7XG4gICAgICBmaW5hbFF1ZXJ5VGV4dCArPSBgIExJTUlUICQke2N1cnJlbnRQYXJhbUlueH1gO1xuICAgICAgcGFyYW1zQXJyLnB1c2gobGltaXQpO1xuICAgICAgY3VycmVudFBhcmFtSW54ICs9IDE7XG4gICAgfVxuICAgIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAnbnVtYmVyJykge1xuICAgICAgZmluYWxRdWVyeVRleHQgKz0gYCBPRkZTRVQgJCR7Y3VycmVudFBhcmFtSW54fWA7XG4gICAgICBwYXJhbXNBcnIucHVzaChvZmZzZXQpO1xuICAgICAgY3VycmVudFBhcmFtSW54ICs9IDE7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBxdWVyeSxcbiAgICBmaW5hbFF1ZXJ5VGV4dCxcbiAgICBjdXJyZW50UGFyYW1JbngsXG4gICAgcGFyYW1zQXJyLFxuICB9O1xufTtcblxuY29uc3QgYWRkUGFyYW1zID0gKHF1ZXJ5QnVpbGRlcjogUXVlcnlCdWlsZGVyKTogUXVlcnlCdWlsZGVyID0+IHtcbiAgY29uc3Qge3F1ZXJ5LCBwYXJhbXNBcnJ9ID0gcXVlcnlCdWlsZGVyO1xuICBsZXQge2ZpbmFsUXVlcnlUZXh0LCBjdXJyZW50UGFyYW1Jbnh9ID0gcXVlcnlCdWlsZGVyO1xuICBjb25zdCB7cGFyYW1zfSA9IHF1ZXJ5O1xuICBpZiAocGFyYW1zKSB7XG4gICAgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKChwYXJhbU5hbWUpID0+IHtcbiAgICAgIGNvbnN0IHNwbGl0UXVlcnlBcnIgPSBmaW5hbFF1ZXJ5VGV4dC5zcGxpdChgOiR7cGFyYW1OYW1lfWApO1xuICAgICAgaWYgKHNwbGl0UXVlcnlBcnIubGVuZ3RoID4gMSkge1xuICAgICAgICBsZXQgbmV3UXVlcnkgPSBzcGxpdFF1ZXJ5QXJyWzBdO1xuICAgICAgICBzcGxpdFF1ZXJ5QXJyLmZvckVhY2goKHBhcnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgaWYgKGluZGV4ID4gMCkge1xuICAgICAgICAgICAgbmV3UXVlcnkgKz0gYCQke2N1cnJlbnRQYXJhbUlueH0ke3BhcnR9YDtcbiAgICAgICAgICAgIHBhcmFtc0Fyci5wdXNoKHBhcmFtc1twYXJhbU5hbWVdKTtcbiAgICAgICAgICAgIGN1cnJlbnRQYXJhbUlueCArPSAxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGZpbmFsUXVlcnlUZXh0ID0gbmV3UXVlcnk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBxdWVyeSxcbiAgICBmaW5hbFF1ZXJ5VGV4dCxcbiAgICBjdXJyZW50UGFyYW1JbngsXG4gICAgcGFyYW1zQXJyLFxuICB9O1xufTtcblxuLyoqIGJ1aWxkIHBvc3RncmVzIHNxbCBxdWVyeSAmIHBhcmFtcyAqL1xuZXhwb3J0IGNvbnN0IGJ1aWxkUXVlcnkgPSAocXVlcnk6IERiUXVlcnkpOiB7cXVlcnlUZXh0OiBzdHJpbmc7IHBhcmFtcz86IHVua25vd25bXX0gPT4ge1xuICBjb25zdCB7ZmluYWxRdWVyeVRleHQsIHBhcmFtc0Fycn0gPSBhZGRQYXJhbXMoXG4gICAgYnVpbGRRdWVyeVdpdGhvdXRQYXJhbXMoe3F1ZXJ5LCBmaW5hbFF1ZXJ5VGV4dDogJycsIGN1cnJlbnRQYXJhbUlueDogMSwgcGFyYW1zQXJyOiBbXX0pLFxuICApO1xuXG4gIHJldHVybiB7XG4gICAgcXVlcnlUZXh0OiBmaW5hbFF1ZXJ5VGV4dCxcbiAgICBwYXJhbXM6IHBhcmFtc0FycixcbiAgfTtcbn07XG4iXX0=