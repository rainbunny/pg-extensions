"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Pool = void 0;

var _pg = require("pg");

var _implementExecutor = require("./implement-executor");

class Pool extends _pg.Pool {
  constructor(config) {
    super(config);

    if (config) {
      const {
        log
      } = config;
      this.log = log;
    }

    (0, _implementExecutor.implementExecutor)(this, this.log);
  }
  /** Execute transaction.
   * Follow https://node-postgres.com/features/transactions
   */


  executeTransaction = async transaction => {
    const client = await this.connect();
    const extendedClient = (0, _implementExecutor.implementExecutor)(client, this.log);
    return extendedClient.query('BEGIN').then(() => transaction(extendedClient)).then(() => extendedClient.query('COMMIT')).catch(e => extendedClient.query('ROLLBACK').then(() => e)).finally(() => extendedClient.release());
  };
}

exports.Pool = Pool;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wb29sLnRzIl0sIm5hbWVzIjpbIlBvb2wiLCJQZ1Bvb2wiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsImxvZyIsImV4ZWN1dGVUcmFuc2FjdGlvbiIsInRyYW5zYWN0aW9uIiwiY2xpZW50IiwiY29ubmVjdCIsImV4dGVuZGVkQ2xpZW50IiwicXVlcnkiLCJ0aGVuIiwiY2F0Y2giLCJlIiwiZmluYWxseSIsInJlbGVhc2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFFQTs7QUFFTyxNQUFNQSxJQUFOLFNBQW1CQyxRQUFuQixDQUFrRDtBQWV2REMsRUFBQUEsV0FBVyxDQUFDQyxNQUFELEVBQThCO0FBQ3ZDLFVBQU1BLE1BQU47O0FBQ0EsUUFBSUEsTUFBSixFQUFZO0FBQ1YsWUFBTTtBQUFDQyxRQUFBQTtBQUFELFVBQVFELE1BQWQ7QUFDQSxXQUFLQyxHQUFMLEdBQVdBLEdBQVg7QUFDRDs7QUFDRCw4Q0FBa0IsSUFBbEIsRUFBd0IsS0FBS0EsR0FBN0I7QUFDRDtBQUVEO0FBQ0Y7QUFDQTs7O0FBQ0VDLEVBQUFBLGtCQUFrQixHQUFHLE1BQU9DLFdBQVAsSUFBcUY7QUFDeEcsVUFBTUMsTUFBTSxHQUFHLE1BQU0sS0FBS0MsT0FBTCxFQUFyQjtBQUNBLFVBQU1DLGNBQWMsR0FBRywwQ0FBc0NGLE1BQXRDLEVBQW9FLEtBQUtILEdBQXpFLENBQXZCO0FBQ0EsV0FBT0ssY0FBYyxDQUNsQkMsS0FESSxDQUNFLE9BREYsRUFFSkMsSUFGSSxDQUVDLE1BQU1MLFdBQVcsQ0FBQ0csY0FBRCxDQUZsQixFQUdKRSxJQUhJLENBR0MsTUFBTUYsY0FBYyxDQUFDQyxLQUFmLENBQXFCLFFBQXJCLENBSFAsRUFJSkUsS0FKSSxDQUlHQyxDQUFELElBQU9KLGNBQWMsQ0FBQ0MsS0FBZixDQUFxQixVQUFyQixFQUFpQ0MsSUFBakMsQ0FBc0MsTUFBTUUsQ0FBNUMsQ0FKVCxFQUtKQyxPQUxJLENBS0ksTUFBTUwsY0FBYyxDQUFDTSxPQUFmLEVBTFYsQ0FBUDtBQU1ELEdBVGlCO0FBM0JxQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7UG9vbCBhcyBQZ1Bvb2x9IGZyb20gJ3BnJztcbmltcG9ydCB0eXBlIHtFeHRlbmRlZFBvb2xDb25maWcsIERiUXVlcnksIEV4dGVuZGVkUG9vbCwgRXh0ZW5kZWRQb29sQ2xpZW50fSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHtpbXBsZW1lbnRFeGVjdXRvcn0gZnJvbSAnLi9pbXBsZW1lbnQtZXhlY3V0b3InO1xuXG5leHBvcnQgY2xhc3MgUG9vbCBleHRlbmRzIFBnUG9vbCBpbXBsZW1lbnRzIEV4dGVuZGVkUG9vbCB7XG4gIGxvZz86IEV4dGVuZGVkUG9vbENvbmZpZ1snbG9nJ107XG5cbiAgZXhlY3V0ZVF1ZXJ5OiA8VD4ocXVlcnk6IERiUXVlcnkpID0+IFByb21pc2U8VFtdPjtcblxuICBjb3VudDogKHF1ZXJ5OiBEYlF1ZXJ5KSA9PiBQcm9taXNlPG51bWJlcj47XG5cbiAgZ2V0QnlJZDogKHRhYmxlOiBzdHJpbmcpID0+IDxSZWNvcmQsIElkPihpZDogSWQsIGZpZWxkcz86IHN0cmluZ1tdLCBpZEZpZWxkPzogc3RyaW5nKSA9PiBQcm9taXNlPFJlY29yZD47XG5cbiAgY3JlYXRlOiAodGFibGU6IHN0cmluZykgPT4gPFJlY29yZCwgSWQ+KHJlY29yZDogUGFydGlhbDxSZWNvcmQ+KSA9PiBQcm9taXNlPElkPjtcblxuICB1cGRhdGU6ICh0YWJsZTogc3RyaW5nKSA9PiA8UmVjb3JkLCBJZD4oaWQ6IElkLCB1cGRhdGVkRGF0YTogUGFydGlhbDxSZWNvcmQ+LCBpZEZpZWxkPzogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+O1xuXG4gIHJlbW92ZTogKHRhYmxlOiBzdHJpbmcpID0+IDxJZD4oaWQ6IElkLCBpZEZpZWxkPzogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+O1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZz86IEV4dGVuZGVkUG9vbENvbmZpZykge1xuICAgIHN1cGVyKGNvbmZpZyk7XG4gICAgaWYgKGNvbmZpZykge1xuICAgICAgY29uc3Qge2xvZ30gPSBjb25maWc7XG4gICAgICB0aGlzLmxvZyA9IGxvZztcbiAgICB9XG4gICAgaW1wbGVtZW50RXhlY3V0b3IodGhpcywgdGhpcy5sb2cpO1xuICB9XG5cbiAgLyoqIEV4ZWN1dGUgdHJhbnNhY3Rpb24uXG4gICAqIEZvbGxvdyBodHRwczovL25vZGUtcG9zdGdyZXMuY29tL2ZlYXR1cmVzL3RyYW5zYWN0aW9uc1xuICAgKi9cbiAgZXhlY3V0ZVRyYW5zYWN0aW9uID0gYXN5bmMgKHRyYW5zYWN0aW9uOiAoY2xpZW50OiBFeHRlbmRlZFBvb2xDbGllbnQpID0+IFByb21pc2U8dm9pZD4pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLmNvbm5lY3QoKTtcbiAgICBjb25zdCBleHRlbmRlZENsaWVudCA9IGltcGxlbWVudEV4ZWN1dG9yPEV4dGVuZGVkUG9vbENsaWVudD4oY2xpZW50IGFzIEV4dGVuZGVkUG9vbENsaWVudCwgdGhpcy5sb2cpO1xuICAgIHJldHVybiBleHRlbmRlZENsaWVudFxuICAgICAgLnF1ZXJ5KCdCRUdJTicpXG4gICAgICAudGhlbigoKSA9PiB0cmFuc2FjdGlvbihleHRlbmRlZENsaWVudCkpXG4gICAgICAudGhlbigoKSA9PiBleHRlbmRlZENsaWVudC5xdWVyeSgnQ09NTUlUJykpXG4gICAgICAuY2F0Y2goKGUpID0+IGV4dGVuZGVkQ2xpZW50LnF1ZXJ5KCdST0xMQkFDSycpLnRoZW4oKCkgPT4gZSkpXG4gICAgICAuZmluYWxseSgoKSA9PiBleHRlbmRlZENsaWVudC5yZWxlYXNlKCkpO1xuICB9O1xufVxuIl19