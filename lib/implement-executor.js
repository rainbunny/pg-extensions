"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.implementExecutor = void 0;

var _executeQuery = require("./execute-query");

var _buildQuery = require("./build-query");

/* eslint-disable no-param-reassign */
const implementExecutor = (executor, log) => {
  /** Execute query */
  executor.executeQuery = async query => {
    const {
      queryText,
      params
    } = (0, _buildQuery.buildQuery)(query);
    return (0, _executeQuery.executeQuery)(executor, queryText, params, log).then(res => res.rows);
  };
  /** Count records in the query */


  executor.count = async query => {
    const {
      queryText,
      params
    } = (0, _buildQuery.buildQuery)({ ...query,
      fields: [],
      pageIndex: undefined,
      rowsPerPage: undefined,
      sortBy: undefined,
      limit: undefined,
      offset: undefined
    });
    const countQueryText = `SELECT COUNT(*) FROM (${queryText}) AS T`;
    return (0, _executeQuery.executeQuery)(executor, countQueryText, params, log).then(res => res.rows[0].count);
  };
  /** Get record by id */


  executor.getById = table => async (id, fields, idField = 'id') => {
    const {
      queryText,
      params
    } = (0, _buildQuery.buildQuery)({
      table,
      whereClause: `${idField} = :id`,
      fields,
      params: {
        id
      }
    });
    return (0, _executeQuery.executeQuery)(executor, queryText, params).then(res => res.rows.length > 0 ? res.rows[0] : undefined);
  };
  /** create new record */


  executor.create = table => async record => {
    const paramNames = Object.keys(record);
    const params = paramNames.map(name => record[name]);
    const fieldsText = paramNames.join(',');
    const paramsText = Array.from(Array(paramNames.length), (_x, i) => `$${i + 1}`).join(',');
    const queryText = `INSERT INTO ${table}(${fieldsText}) VALUES(${paramsText}) RETURNING id`;
    return (0, _executeQuery.executeQuery)(executor, queryText, params, log).then(res => res.rows[0].id);
  };
  /** update existing record */


  executor.update = table => async (id, updatedData, idField = 'id') => {
    const paramNames = Object.keys(updatedData);
    const params = paramNames.map(name => updatedData[name]);
    const paramsText = paramNames.map((paramName, index) => `${paramName}=$${index + 2}`).join(',');
    const queryText = `UPDATE ${table} SET ${paramsText} WHERE ${idField} = $1`;
    await (0, _executeQuery.executeQuery)(executor, queryText, [id, ...params], log);
  };
  /** delete existing record */


  executor.remove = table => async (id, idField = 'id') => {
    const queryText = `DELETE FROM ${table} WHERE ${idField} = $1`;
    await (0, _executeQuery.executeQuery)(executor, queryText, [id], log);
  };

  return executor;
};

exports.implementExecutor = implementExecutor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbXBsZW1lbnQtZXhlY3V0b3IudHMiXSwibmFtZXMiOlsiaW1wbGVtZW50RXhlY3V0b3IiLCJleGVjdXRvciIsImxvZyIsImV4ZWN1dGVRdWVyeSIsInF1ZXJ5IiwicXVlcnlUZXh0IiwicGFyYW1zIiwidGhlbiIsInJlcyIsInJvd3MiLCJjb3VudCIsImZpZWxkcyIsInBhZ2VJbmRleCIsInVuZGVmaW5lZCIsInJvd3NQZXJQYWdlIiwic29ydEJ5IiwibGltaXQiLCJvZmZzZXQiLCJjb3VudFF1ZXJ5VGV4dCIsImdldEJ5SWQiLCJ0YWJsZSIsImlkIiwiaWRGaWVsZCIsIndoZXJlQ2xhdXNlIiwibGVuZ3RoIiwiY3JlYXRlIiwicmVjb3JkIiwicGFyYW1OYW1lcyIsIk9iamVjdCIsImtleXMiLCJtYXAiLCJuYW1lIiwiZmllbGRzVGV4dCIsImpvaW4iLCJwYXJhbXNUZXh0IiwiQXJyYXkiLCJmcm9tIiwiX3giLCJpIiwidXBkYXRlIiwidXBkYXRlZERhdGEiLCJwYXJhbU5hbWUiLCJpbmRleCIsInJlbW92ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUdBOztBQUNBOztBQUpBO0FBTU8sTUFBTUEsaUJBQWlCLEdBQUcsQ0FDL0JDLFFBRCtCLEVBRS9CQyxHQUYrQixLQUdwQjtBQUNYO0FBQ0FELEVBQUFBLFFBQVEsQ0FBQ0UsWUFBVCxHQUF3QixNQUFVQyxLQUFWLElBQTJDO0FBQ2pFLFVBQU07QUFBQ0MsTUFBQUEsU0FBRDtBQUFZQyxNQUFBQTtBQUFaLFFBQXNCLDRCQUFXRixLQUFYLENBQTVCO0FBQ0EsV0FBTyxnQ0FBZ0JILFFBQWhCLEVBQTBCSSxTQUExQixFQUFxQ0MsTUFBckMsRUFBNkNKLEdBQTdDLEVBQWtESyxJQUFsRCxDQUF3REMsR0FBRCxJQUFTQSxHQUFHLENBQUNDLElBQXBFLENBQVA7QUFDRCxHQUhEO0FBS0E7OztBQUNBUixFQUFBQSxRQUFRLENBQUNTLEtBQVQsR0FBaUIsTUFBT04sS0FBUCxJQUEyQztBQUMxRCxVQUFN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SUFBVVMsV0FBVyxDQUFDVCxJQUFELENBQXBDLENBQWY7QUFDQSxVQUFNRyxVQUFVLEdBQUdQLFVBQVUsQ0FBQ0csR0FBWCxDQUFlLENBQUNXLFNBQUQsRUFBWUMsS0FBWixLQUF1QixHQUFFRCxTQUFVLEtBQUlDLEtBQUssR0FBRyxDQUFFLEVBQWhFLEVBQW1FVCxJQUFuRSxDQUF3RSxHQUF4RSxDQUFuQjtBQUNBLFVBQU01QixTQUFTLEdBQUksVUFBU2UsS0FBTSxRQUFPYyxVQUFXLFVBQVNaLE9BQVEsT0FBckU7QUFDQSxVQUFNLGdDQUF1QnJCLFFBQXZCLEVBQWlDSSxTQUFqQyxFQUE0QyxDQUFDZ0IsRUFBRCxFQUFLLEdBQUdmLE1BQVIsQ0FBNUMsRUFBNkRKLEdBQTdELENBQU47QUFDRCxHQVZEO0FBWUE7OztBQUNBRCxFQUFBQSxRQUFRLENBQUMwQyxNQUFULEdBQW1CdkIsS0FBRCxJQUFtQixPQUFXQyxFQUFYLEVBQW1CQyxPQUFPLEdBQUcsSUFBN0IsS0FBcUQ7QUFDeEYsVUFBTWpCLFNBQVMsR0FBSSxlQUFjZSxLQUFNLFVBQVNFLE9BQVEsT0FBeEQ7QUFDQSxVQUFNLGdDQUFhckIsUUFBYixFQUF1QkksU0FBdkIsRUFBa0MsQ0FBQ2dCLEVBQUQsQ0FBbEMsRUFBd0NuQixHQUF4QyxDQUFOO0FBQ0QsR0FIRDs7QUFLQSxTQUFPRCxRQUFQO0FBQ0QsQ0FuRU0iLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1wYXJhbS1yZWFzc2lnbiAqL1xuaW1wb3J0IHR5cGUge0RiUXVlcnksIEV4ZWN1dG9yLCBFeHRlbmRlZFBvb2wsIEV4dGVuZGVkUG9vbENsaWVudCwgTG9nZ2VyfSBmcm9tICdAbGliL2ludGVyZmFjZXMnO1xuXG5pbXBvcnQge2V4ZWN1dGVRdWVyeX0gZnJvbSAnLi9leGVjdXRlLXF1ZXJ5JztcbmltcG9ydCB7YnVpbGRRdWVyeX0gZnJvbSAnLi9idWlsZC1xdWVyeSc7XG5cbmV4cG9ydCBjb25zdCBpbXBsZW1lbnRFeGVjdXRvciA9IDxTb3VyY2UgZXh0ZW5kcyBFeHRlbmRlZFBvb2wgfCBFeHRlbmRlZFBvb2xDbGllbnQ+KFxuICBleGVjdXRvcjogU291cmNlICYgRXhlY3V0b3IsXG4gIGxvZz86IExvZ2dlcixcbik6IFNvdXJjZSA9PiB7XG4gIC8qKiBFeGVjdXRlIHF1ZXJ5ICovXG4gIGV4ZWN1dG9yLmV4ZWN1dGVRdWVyeSA9IGFzeW5jIDxUPihxdWVyeTogRGJRdWVyeSk6IFByb21pc2U8VFtdPiA9PiB7XG4gICAgY29uc3Qge3F1ZXJ5VGV4dCwgcGFyYW1zfSA9IGJ1aWxkUXVlcnkocXVlcnkpO1xuICAgIHJldHVybiBleGVjdXRlUXVlcnk8VD4oZXhlY3V0b3IsIHF1ZXJ5VGV4dCwgcGFyYW1zLCBsb2cpLnRoZW4oKHJlcykgPT4gcmVzLnJvd3MpO1xuICB9O1xuXG4gIC8qKiBDb3VudCByZWNvcmRzIGluIHRoZSBxdWVyeSAqL1xuICBleGVjdXRvci5jb3VudCA9IGFzeW5jIChxdWVyeTogRGJRdWVyeSk6IFByb21pc2U8bnVtYmVyPiA9PiB7XG4gICAgY29uc3Qge3F1ZXJ5VGV4dCwgcGFyYW1zfSA9IGJ1aWxkUXVlcnkoe1xuICAgICAgLi4ucXVlcnksXG4gICAgICBmaWVsZHM6IFtdLFxuICAgICAgcGFnZUluZGV4OiB1bmRlZmluZWQsXG4gICAgICByb3dzUGVyUGFnZTogdW5kZWZpbmVkLFxuICAgICAgc29ydEJ5OiB1bmRlZmluZWQsXG4gICAgICBsaW1pdDogdW5kZWZpbmVkLFxuICAgICAgb2Zmc2V0OiB1bmRlZmluZWQsXG4gICAgfSk7XG4gICAgY29uc3QgY291bnRRdWVyeVRleHQgPSBgU0VMRUNUIENPVU5UKCopIEZST00gKCR7cXVlcnlUZXh0fSkgQVMgVGA7XG4gICAgcmV0dXJuIGV4ZWN1dGVRdWVyeTx7Y291bnQ6IG51bWJlcn0+KGV4ZWN1dG9yLCBjb3VudFF1ZXJ5VGV4dCwgcGFyYW1zLCBsb2cpLnRoZW4oKHJlcykgPT4gcmVzLnJvd3NbMF0uY291bnQpO1xuICB9O1xuXG4gIC8qKiBHZXQgcmVjb3JkIGJ5IGlkICovXG4gIGV4ZWN1dG9yLmdldEJ5SWQgPSAodGFibGU6IHN0cmluZykgPT4gYXN5bmMgPFJlY29yZCwgSWQ+KFxuICAgIGlkOiBJZCxcbiAgICBmaWVsZHM/OiBzdHJpbmdbXSxcbiAgICBpZEZpZWxkID0gJ2lkJyxcbiAgKTogUHJvbWlzZTxSZWNvcmQgfCB1bmRlZmluZWQ+ID0+IHtcbiAgICBjb25zdCB7cXVlcnlUZXh0LCBwYXJhbXN9ID0gYnVpbGRRdWVyeSh7dGFibGUsIHdoZXJlQ2xhdXNlOiBgJHtpZEZpZWxkfSA9IDppZGAsIGZpZWxkcywgcGFyYW1zOiB7aWR9fSk7XG4gICAgcmV0dXJuIGV4ZWN1dGVRdWVyeTxSZWNvcmQ+KGV4ZWN1dG9yLCBxdWVyeVRleHQsIHBhcmFtcykudGhlbigocmVzKSA9PlxuICAgICAgcmVzLnJvd3MubGVuZ3RoID4gMCA/IHJlcy5yb3dzWzBdIDogdW5kZWZpbmVkLFxuICAgICk7XG4gIH07XG5cbiAgLyoqIGNyZWF0ZSBuZXcgcmVjb3JkICovXG4gIGV4ZWN1dG9yLmNyZWF0ZSA9ICh0YWJsZTogc3RyaW5nKSA9PiBhc3luYyA8UmVjb3JkLCBJZD4ocmVjb3JkOiBQYXJ0aWFsPFJlY29yZD4pOiBQcm9taXNlPElkPiA9PiB7XG4gICAgY29uc3QgcGFyYW1OYW1lcyA9IE9iamVjdC5rZXlzKHJlY29yZCkgYXMgKGtleW9mIFJlY29yZClbXTtcbiAgICBjb25zdCBwYXJhbXMgPSBwYXJhbU5hbWVzLm1hcCgobmFtZSkgPT4gcmVjb3JkW25hbWVdKTtcbiAgICBjb25zdCBmaWVsZHNUZXh0ID0gcGFyYW1OYW1lcy5qb2luKCcsJyk7XG4gICAgY29uc3QgcGFyYW1zVGV4dCA9IEFycmF5LmZyb20oQXJyYXkocGFyYW1OYW1lcy5sZW5ndGgpLCAoX3gsIGkpID0+IGAkJHtpICsgMX1gKS5qb2luKCcsJyk7XG4gICAgY29uc3QgcXVlcnlUZXh0ID0gYElOU0VSVCBJTlRPICR7dGFibGV9KCR7ZmllbGRzVGV4dH0pIFZBTFVFUygke3BhcmFtc1RleHR9KSBSRVRVUk5JTkcgaWRgO1xuICAgIHJldHVybiBleGVjdXRlUXVlcnk8e2lkOiBuZXZlcn0+KGV4ZWN1dG9yLCBxdWVyeVRleHQsIHBhcmFtcywgbG9nKS50aGVuKChyZXMpID0+IHJlcy5yb3dzWzBdLmlkKTtcbiAgfTtcblxuICAvKiogdXBkYXRlIGV4aXN0aW5nIHJlY29yZCAqL1xuICBleGVjdXRvci51cGRhdGUgPSAodGFibGU6IHN0cmluZykgPT4gYXN5bmMgPFJlY29yZCwgSWQ+KFxuICAgIGlkOiBJZCxcbiAgICB1cGRhdGVkRGF0YTogUGFydGlhbDxSZWNvcmQ+LFxuICAgIGlkRmllbGQgPSAnaWQnLFxuICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCBwYXJhbU5hbWVzID0gT2JqZWN0LmtleXModXBkYXRlZERhdGEpIGFzIChrZXlvZiBSZWNvcmQpW107XG4gICAgY29uc3QgcGFyYW1zID0gcGFyYW1OYW1lcy5tYXAoKG5hbWUpID0+IHVwZGF0ZWREYXRhW25hbWVdKTtcbiAgICBjb25zdCBwYXJhbXNUZXh0ID0gcGFyYW1OYW1lcy5tYXAoKHBhcmFtTmFtZSwgaW5kZXgpID0+IGAke3BhcmFtTmFtZX09JCR7aW5kZXggKyAyfWApLmpvaW4oJywnKTtcbiAgICBjb25zdCBxdWVyeVRleHQgPSBgVVBEQVRFICR7dGFibGV9IFNFVCAke3BhcmFtc1RleHR9IFdIRVJFICR7aWRGaWVsZH0gPSAkMWA7XG4gICAgYXdhaXQgZXhlY3V0ZVF1ZXJ5PHtpZDogSWR9PihleGVjdXRvciwgcXVlcnlUZXh0LCBbaWQsIC4uLnBhcmFtc10sIGxvZyk7XG4gIH07XG5cbiAgLyoqIGRlbGV0ZSBleGlzdGluZyByZWNvcmQgKi9cbiAgZXhlY3V0b3IucmVtb3ZlID0gKHRhYmxlOiBzdHJpbmcpID0+IGFzeW5jIDxJZD4oaWQ6IElkLCBpZEZpZWxkID0gJ2lkJyk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IHF1ZXJ5VGV4dCA9IGBERUxFVEUgRlJPTSAke3RhYmxlfSBXSEVSRSAke2lkRmllbGR9ID0gJDFgO1xuICAgIGF3YWl0IGV4ZWN1dGVRdWVyeShleGVjdXRvciwgcXVlcnlUZXh0LCBbaWRdLCBsb2cpO1xuICB9O1xuXG4gIHJldHVybiBleGVjdXRvcjtcbn07XG4iXX0=